/** Oslo JavaScript Framework. */
define("@debug.Trace",["@util","@array","@iter.util","@log","@ds.Map","@ds.SimplePool"],function(a,b,c,d,e,f){"use strict";var g=function(){this.events_=[],this.outstandingEvents_=new e,this.startTime_=0,this.tracerOverheadStart_=0,this.tracerOverheadEnd_=0,this.tracerOverheadComment_=0,this.stats_=new e,this.tracerCount_=0,this.commentCount_=0,this.nextId_=1,this.eventPool_=new f(0,4e3),this.eventPool_.createObject=function(){return new g.Event_},this.statPool_=new f(0,50),this.statPool_.createObject=function(){return new g.Stat_};var a=this;this.idPool_=new f(0,2e3),this.idPool_.createObject=function(){return String(a.nextId_++)},this.idPool_.disposeObject=function(){},this.defaultThreshold_=3};return g.prototype.logger_=d.getLogger("Oslo.debug.Trace"),g.prototype.MAX_TRACE_SIZE=1e3,g.EventType={START:0,STOP:1,COMMENT:2},g.Stat_=function(){this.count=0,this.time=0,this.varAlloc=0},g.Stat_.prototype.type,g.Stat_.prototype.toString=function(){var a=[];return a.push(this.type," ",this.count," (",Math.round(10*this.time)/10," ms)"),this.varAlloc&&a.push(" [VarAlloc = ",this.varAlloc,"]"),a.join("")},g.Event_=function(){},g.Event_.prototype.type,g.Event_.prototype.toTraceString=function(a,b,c){var d=[];if(-1==b?d.push("    "):d.push(g.longToPaddedString_(this.eventTime-b)),d.push(" ",g.formatTime_(this.eventTime-a)),this.eventType==g.EventType.START)d.push(" Start        ");else if(this.eventType==g.EventType.STOP){d.push(" Done ");var e=this.stopTime-this.startTime;d.push(g.longToPaddedString_(e)," ms ")}else d.push(" Comment      ");return d.push(c,this),this.totalVarAlloc>0&&d.push("[VarAlloc ",this.totalVarAlloc,"] "),d.join("")},g.Event_.prototype.toString=function(){return null==this.type?this.comment:"["+this.type+"] "+this.comment},g.prototype.setStartTime=function(a){this.startTime_=a},g.prototype.initCurrentTrace=function(a){this.reset(a)},g.prototype.clearCurrentTrace=function(){this.reset(0)},g.prototype.reset=function(a){this.defaultThreshold_=a;for(var b=0;b<this.events_.length;b++){var c=this.eventPool_.id;c&&this.idPool_.releaseObject(c),this.eventPool_.releaseObject(this.events_[b])}this.events_.length=0,this.outstandingEvents_.clear(),this.startTime_=g.now(),this.tracerOverheadStart_=0,this.tracerOverheadEnd_=0,this.tracerOverheadComment_=0,this.tracerCount_=0,this.commentCount_=0;for(var d=this.stats_.getKeys(),b=0;b<d.length;b++){var e=d[b],f=this.stats_.get(e);f.count=0,f.time=0,f.varAlloc=0,this.statPool_.releaseObject(f)}this.stats_.clear()},g.prototype.startTracer=function(a,b){var c=g.now(),e=this.getTotalVarAlloc(),f=this.outstandingEvents_.getCount();if(this.events_.length+f>this.MAX_TRACE_SIZE){if(d.warning(this.logger_,"Giant thread trace. Clearing to avoid memory leak."),this.events_.length>this.MAX_TRACE_SIZE/2){for(var h=0;h<this.events_.length;h++){var i=this.events_[h];i.id&&this.idPool_.releaseObject(i.id),this.eventPool_.releaseObject(i)}this.events_.length=0}f>this.MAX_TRACE_SIZE/2&&this.outstandingEvents_.clear()}goog.debug.Logger.logToProfilers("Start : "+a);var i=this.eventPool_.getObject();i.totalVarAlloc=e,i.eventType=g.EventType.START,i.id=Number(this.idPool_.getObject()),i.comment=a,i.type=b,this.events_.push(i),this.outstandingEvents_.set(String(i.id),i),this.tracerCount_++;var j=g.now();return i.startTime=i.eventTime=j,this.tracerOverheadStart_+=j-c,i.id},g.prototype.stopTracer=function(a,b){var c,d=g.now();c=0===b?0:b?b:this.defaultThreshold_;var e=this.outstandingEvents_.get(String(a));if(null==e)return null;this.outstandingEvents_.remove(String(a));var f,h=d-e.startTime;if(c>h)for(var i=this.events_.length,j=i-1;j>=0;j--){var k=this.events_[j];if(k==e){this.events_.splice(j,1),this.idPool_.releaseObject(e.id),this.eventPool_.releaseObject(e);break}}else f=this.eventPool_.getObject(),f.eventType=g.EventType.STOP,f.startTime=e.startTime,f.comment=e.comment,f.type=e.type,f.stopTime=f.eventTime=d,this.events_.push(f);var l=e.type,m=null;l&&(m=this.getStat_(l),m.count++,m.time+=h),f&&(goog.debug.Logger.logToProfilers("Stop : "+f.comment),f.totalVarAlloc=this.getTotalVarAlloc(),m&&(m.varAlloc+=f.totalVarAlloc-e.totalVarAlloc));var n=g.now();return this.tracerOverheadEnd_+=n-d,h},g.prototype.setGcTracer=function(a){this.gcTracer_=a},g.prototype.getTotalVarAlloc=function(){var a=this.gcTracer_;return a&&a.isTracing()?a.totalVarAlloc:-1},g.prototype.addComment=function(a,c,d){var e=g.now(),f=d?d:e,h=this.eventPool_.getObject();if(h.eventType=g.EventType.COMMENT,h.eventTime=f,h.type=c,h.comment=a,h.totalVarAlloc=this.getTotalVarAlloc(),this.commentCount_++,d){for(var i=this.events_.length,j=0;i>j;j++){var k=this.events_[j],l=k.eventTime;if(l>f){b.insertAt(this.events_,h,j);break}}j==i&&this.events_.push(h)}else this.events_.push(h);var m=h.type;if(m){var n=this.getStat_(m);n.count++}this.tracerOverheadComment_+=g.now()-e},g.prototype.getStat_=function(a){var b=this.stats_.get(a);return b||(b=this.statPool_.getObject(),b.type=a,this.stats_.set(a,b)),b},g.prototype.getFormattedTrace=function(){return this.toString()},g.prototype.toString=function(){for(var a=[],b=-1,d=[],e=0;e<this.events_.length;e++){var f=this.events_[e];f.eventType==g.EventType.STOP&&d.pop(),a.push(" ",f.toTraceString(this.startTime_,b,d.join(""))),b=f.eventTime,a.push("\n"),f.eventType==g.EventType.START&&d.push("|  ")}if(0!=this.outstandingEvents_.getCount()){var h=g.now();a.push(" Unstopped timers:\n"),c.forEach(this.outstandingEvents_,function(b){a.push("  ",b," (",h-b.startTime," ms, started at ",g.formatTime_(b.startTime),")\n")})}for(var i=this.stats_.getKeys(),e=0;e<i.length;e++){var j=this.stats_.get(i[e]);j.count>1&&a.push(" TOTAL ",j,"\n")}return a.push("Total tracers created ",this.tracerCount_,"\n","Total comments created ",this.commentCount_,"\n","Overhead start: ",this.tracerOverheadStart_," ms\n","Overhead end: ",this.tracerOverheadEnd_," ms\n","Overhead comment: ",this.tracerOverheadComment_," ms\n"),a.join("")},g.longToPaddedString_=function(a){a=Math.round(a);var b="";return 1e3>a&&(b=" "),100>a&&(b="  "),10>a&&(b="   "),b+a},g.formatTime_=function(a){a=Math.round(a);var b=a/1e3%60,c=a%1e3;return String(100+b).substring(1,3)+"."+String(1e3+c).substring(1,4)},g.now=function(){return a.now()},new g});