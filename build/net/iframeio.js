/** Oslo JavaScript Framework. */
define(["../util/util","../timer/timer","../uri/util","../dom/util","../events/util","../events/event","../events/target","../events/eventtype","../json/json","./errorcode","./eventtype","../string/util","../ua/util","../log/log","../ds/util","../uri/uri","../debug/util","../reflect/reflect","./incredataevent"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){"use strict";var t=0,u={};function v(){return w+t++}var w="oslo_frame",x="_inner",y=2e3,z=function(){g.call(this),this.name_=v(),this.iframesForDisposal_=[],u[this.name_]=this};return a.inherits(z,g),z.form_,z.send=function(a,b,c,d,f){var g=new z;e.listen(g,k.READY,g.dispose,!1,g),b&&e.listen(g,k.COMPLETE,b),g.send(a,c,d,f)},z.getIframeByName=function(a){return window.frames[a]},z.getInstanceByName=function(a){return u[a]},z.handleIncrementalData=function(a,b){var c=l.endsWith(a.name,x)?a.parent.name:a.name,d=c.substring(0,c.lastIndexOf("_")),e=z.getInstanceByName(d);e&&c===e.iframeName_?e.handleIncrementalData_(b):n.getLogger("Oslo.net.IframeIo").info("Incremental iframe data routed for unknown iframe")},z.getForm_=function(){if(!z.form_){z.form_=d.createDom("form"),z.form_.acceptCharset="utf-8";var a=z.form_.style;a.position="absolute",a.visibility="hidden",a.top=a.left="-10px",a.width=a.height="10px",a.overflow="hidden",d.getDocument().body.appendChild(z.form_)}return z.form_},z.addFormInputs_=function(a,b){var c=d.getDomHelper(a);o.forEach(b,function(b,d){var e=c.createDom("input",{type:"hidden",name:d,value:b});a.appendChild(e)})},z.prototype.logger_=n.getLogger("Oslo.net.IframeIo"),z.prototype.form_=null,z.prototype.iframe_=null,z.prototype.iframeName_=null,z.prototype.nextIframeId_=0,z.prototype.active_=!1,z.prototype.complete_=!1,z.prototype.success_=!1,z.prototype.lastUri_=null,z.prototype.lastContent_=null,z.prototype.lastErrorCode_=j.NO_ERROR,z.prototype.timeoutInterval_=0,z.prototype.timeoutId_=null,z.prototype.firefoxSilentErrorTimeout_=null,z.prototype.iframeDisposalTimer_=null,z.prototype.errorHandled_=!1,z.prototype.ignoreResponse_=!1,z.prototype.send=function(a,b,c,d){if(this.active_)throw Error("[Oslo.net.IframeIo] Unable to send, already active.");var e=new p(a);this.lastUri_=e;var f=b?b.toUpperCase():"GET";c&&e.makeUnique(),n.info(this.logger_,"Sending iframe request: "+e+" ["+f+"]"),this.form_=z.getForm_(),"GET"==f&&z.addFormInputs_(this.form_,e.getQueryData()),d&&z.addFormInputs_(this.form_,d),this.form_.action=e.toString(),this.form_.method=f,this.sendFormInternal_()},z.prototype.sendFromForm=function(a,b,c){if(this.active_)throw Error("[Oslo.net.IframeIo] Unable to send, already active.");var d=new p(b||a.action);c&&d.makeUnique(),n.info(this.logger_,"Sending iframe request from form: "+d),this.lastUri_=d,this.form_=a,this.form_.action=d.toString(),this.sendFormInternal_()},z.prototype.abort=function(a){this.active_&&(n.info(this.logger_,"Request aborted"),e.removeAll(this.getRequestIframe()),this.complete_=!1,this.active_=!1,this.success_=!1,this.lastErrorCode_=a||j.ABORT,this.dispatchEvent(k.ABORT),this.makeReady_())},z.prototype.disposeInternal=function(){n.fine(this.logger_,"Disposing iframeIo instance"),this.active_&&(n.fine(this.logger_,"Aborting active request"),this.abort()),z.superClass_.disposeInternal.call(this),this.iframe_&&this.scheduleIframeDisposal_(),this.disposeForm_(),delete this.errorChecker_,this.form_=null,this.lastCustomError_=this.lastContent_=this.lastContentHtml_=null,this.lastUri_=null,this.lastErrorCode_=j.NO_ERROR,delete u[this.name_]},z.prototype.isComplete=function(){return this.complete_},z.prototype.isSuccess=function(){return this.success_},z.prototype.isActive=function(){return this.active_},z.prototype.getResponseText=function(){return this.lastContent_},z.prototype.getResponseHtml=function(){return this.lastContentHtml_},z.prototype.getResponseJson=function(){return json.parse(this.lastContent_)},z.prototype.getLastUri=function(){return this.lastUri_},z.prototype.getLastErrorCode=function(){return this.lastErrorCode_},z.prototype.getLastError=function(){return j.getDebugMessage(this.lastErrorCode_)},z.prototype.getLastCustomError=function(){return this.lastCustomError_},z.prototype.setErrorChecker=function(a){this.errorChecker_=a},z.prototype.getErrorChecker=function(){return this.errorChecker_},z.prototype.getTimeoutInterval=function(){return this.timeoutInterval_},z.prototype.setTimeoutInterval=function(a){this.timeoutInterval_=Math.max(0,a)},z.prototype.isIgnoringResponse=function(){return this.ignoreResponse_},z.prototype.setIgnoreResponse=function(a){this.ignoreResponse_=a},z.prototype.sendFormInternal_=function(){if(this.active_=!0,this.complete_=!1,this.lastErrorCode_=j.NO_ERROR,this.createIframe_(),m.isIE){this.form_.target=this.iframeName_||"",this.appendIframe_(),this.ignoreResponse_||e.listen(this.iframe_,h.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this);try{this.errorHandled_=!1,this.form_.submit()}catch(a){this.ignoreResponse_||e.unlisten(this.iframe_,h.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this),this.handleError_(j.ACCESS_DENIED)}}else{n.fine(this.logger_,"Setting up iframes and cloning form"),this.appendIframe_();var c=this.iframeName_+x,f=d.getFrameContentDocument(this.iframe_),g="<body><iframe id="+c+" name="+c+"></iframe>";document.baseURI&&(g='<head><base href="'+l.htmlEscape(document.baseURI)+'"></head>'+g),m.isOPERA?f.documentElement.innerHTML=g:f.write(g),this.ignoreResponse_||e.listen(f.getElementById(c),h.LOAD,this.onIframeLoaded_,!1,this);var i,k,o=this.form_.getElementsByTagName("textarea");for(i=0,k=o.length;k>i;i++){var p=o[i].value;d.getRawTextContent(o[i])!==p&&(d.setTextContent(o[i],p),o[i].value=p)}var r=f.importNode(this.form_,!0);r.target=c,r.action=this.form_.action,f.body.appendChild(r);var s=this.form_.getElementsByTagName("select"),t=r.getElementsByTagName("select");for(i=0,k=s.length;k>i;i++)for(var u=s[i].getElementsByTagName("option"),v=t[i].getElementsByTagName("option"),w=0,y=u.length;y>w;w++)v[w].selected=u[w].selected;var z=this.form_.getElementsByTagName("input"),A=r.getElementsByTagName("input");for(i=0,k=z.length;k>i;i++)if("file"===z[i].type&&z[i].value!==A[i].value){n.fine(this.logger_,"File input value not cloned properly. Will submit using original form."),this.form_.target=c,r=this.form_;break}n.fine(this.logger_,"Submitting form");try{this.errorHandled_=!1,r.submit(),f.close(),m.isGECKO&&(this.firefoxSilentErrorTimeout_=b.callOnce(this.testForFirefoxSilentError_,250,this))}catch(a){n.error(this.logger_,"Error when submitting form: "+q.exposeException(a)),this.ignoreResponse_||e.unlisten(f.getElementById(c),h.LOAD,this.onIframeLoaded_,!1,this),f.close(),this.handleError_(j.FILE_NOT_FOUND)}}},z.prototype.onIeReadyStateChange_=function(){if("complete"===this.iframe_.readyState){e.unlisten(this.iframe_,h.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this);var a;try{if(a=d.getFrameContentDocument(this.iframe_),m.isIE&&"about:blank"===a.location&&!navigator.onLine)return this.handleError_(j.OFFLINE),void 0}catch(b){return this.handleError_(j.ACCESS_DENIED),void 0}this.handleLoad_(a)}},z.prototype.onIframeLoaded_=function(){m.isOPERA&&"about:blank"===this.getContentDocument_().location||(e.unlisten(this.getRequestIframe(),h.LOAD,this.onIframeLoaded_,!1,this),this.handleLoad_(this.getContentDocument_()))},z.prototype.handleLoad_=function(a){n.fine(this.logger_,"Iframe loaded"),this.complete_=!0,this.active_=!1;var b;try{var c=a.body;this.lastContent_=c.textContent||c.innerText,this.lastContentHtml_=c.innerHTML}catch(d){b=j.ACCESS_DENIED}var e;b||"function"!=typeof this.errorChecker_||(e=this.errorChecker_(a),e&&(b=j.CUSTOM_ERROR)),n.log(this.logger_,n.Level.FINER,"Last content: "+this.lastContent_),n.log(this.logger_,n.Level.FINER,"Last uri: "+this.lastUri_),b?(n.fine(this.logger_,"Load event occurred but failed"),this.handleError_(b,e)):(n.fine(this.logger_,"Load succeeded"),this.success_=!0,this.lastErrorCode_=j.NO_ERROR,this.dispatchEvent(k.COMPLETE),this.dispatchEvent(k.SUCCESS),this.makeReady_())},z.prototype.handleError_=function(a,b){this.errorHandled_||(this.success_=!1,this.active_=!1,this.complete_=!0,this.lastErrorCode_=a,a===j.CUSTOM_ERROR&&(this.lastCustomError_=b),this.dispatchEvent(k.COMPLETE),this.dispatchEvent(k.ERROR),this.makeReady_(),this.errorHandled_=!0)},z.prototype.handleIncrementalData_=function(a){this.dispatchEvent(new s(a))},z.prototype.makeReady_=function(){n.info(this.logger_,"Ready for new requests"),this.iframe_,this.scheduleIframeDisposal_(),this.disposeForm_(),this.dispatchEvent(k.READY)},z.prototype.createIframe_=function(){n.fine(this.logger_,"Creating iframe"),this.iframeName_=this.name_+"_"+(this.nextIframeId_++).toString(36);var a={name:this.iframeName_,id:this.iframeName_};m.isIE&&m.VERSION<7&&(a.src='javascript:""'),this.iframe_=d.getDomHelper(this.form_).createDom("iframe",a);var b=this.iframe_.style;b.visibility="hidden",b.width=b.height="10px",b.display="none",m.isWEBKIT?b.marginTop=b.marginLeft="-10px":(b.position="absolute",b.top=b.left="-10px")},z.prototype.appendIframe_=function(){d.getDomHelper(this.form_).getDocument().body.appendChild(this.iframe_)},z.prototype.scheduleIframeDisposal_=function(){var a=this.iframe_;a&&(a.onreadystatechange=null,a.onload=null,a.onerror=null,this.iframesForDisposal_.push(a)),this.iframeDisposalTimer_&&(b.clear(this.iframeDisposalTimer_),this.iframeDisposalTimer_=null),m.isGECKO||m.isOPERA?this.iframeDisposalTimer_=b.callOnce(this.disposeIframes_,y,this):this.disposeIframes_(),this.iframe_=null,this.iframeName_=null},z.prototype.disposeIframes_=function(){for(this.iframeDisposalTimer_&&(b.clear(this.iframeDisposalTimer_),this.iframeDisposalTimer_=null);0!==this.iframesForDisposal_.length;){var a=this.iframesForDisposal_.pop();n.info(this.logger_,"Disposing iframe"),d.removeNode(a)}},z.prototype.disposeForm_=function(){this.form_&&this.form_===z.form_&&d.removeChildren(this.form_),this.form_=null},z.prototype.getContentDocument_=function(){return this.iframe_?d.getFrameContentDocument(this.getRequestIframe()):null},z.prototype.getRequestIframe=function(){return this.iframe_?m.isIE?this.iframe_:d.getFrameContentDocument(this.iframe_).getElementById(this.iframeName_+x):null},z.prototype.testForFirefoxSilentError_=function(){if(this.active_){var a=this.getContentDocument_();if(a&&!r.canAccessProperty(a,"documentUri"))return this.ignoreResponse_||e.unlisten(this.getRequestIframe(),h.LOAD,this.onIframeLoaded_,!1,this),navigator.onLine?(n.warning(this.logger_,"Silent Firefox error detected"),this.handleError_(j.FF_SILENT_ERROR)):(n.warning(this.logger_,"Firefox is offline so report offline error instead of silent error"),this.handleError_(j.OFFLINE)),void 0;this.firefoxSilentErrorTimeout_=b.callOnce(this.testForFirefoxSilentError_,250,this)}},z});