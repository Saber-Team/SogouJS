/** Oslo JavaScript Framework. */
define(["../util/util","../timer/timer","../uri/util","../dom/util","../events/util","../events/event","../events/target","../events/eventtype","../json/json","./errorcode","./eventtype","../string/util","../ua/util","../log/log","../ds/util","../uri/uri"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){"use strict";var q=0,r={};function s(){return t.FRAME_NAME_PREFIX+q++}var t=function(){g.call(this),this.name_=s(),this.iframesForDisposal_=[],r[this.name_]=this};return a.inherits(t,g),t.FRAME_NAME_PREFIX="oslo_frame",t.INNER_FRAME_SUFFIX="_inner",t.IFRAME_DISPOSE_DELAY_MS=2e3,t.form_,t.send=function(a,b,c,d,f){var g=new t;e.listen(g,k.READY,g.dispose,!1,g),b&&e.listen(g,k.COMPLETE,b),g.send(a,c,d,f)},t.getIframeByName=function(a){return window.frames[a]},t.getInstanceByName=function(a){return r[a]},t.handleIncrementalData=function(a,b){var c=l.endsWith(a.name,t.INNER_FRAME_SUFFIX)?a.parent.name:a.name,d=c.substring(0,c.lastIndexOf("_")),e=t.getInstanceByName(d);e&&c===e.iframeName_?e.handleIncrementalData_(b):n.getLogger("Oslo.net.IframeIo").info("Incremental iframe data routed for unknown iframe")},t.getForm_=function(){if(!t.form_){t.form_=d.createDom("form"),t.form_.acceptCharset="utf-8";var a=t.form_.style;a.position="absolute",a.visibility="hidden",a.top=a.left="-10px",a.width=a.height="10px",a.overflow="hidden",d.getDocument().body.appendChild(t.form_)}return t.form_},t.addFormInputs_=function(a,b){var c=d.getDomHelper(a);o.forEach(b,function(b,d){var e=c.createDom("input",{type:"hidden",name:d,value:b});a.appendChild(e)})},t.prototype.logger_=n.getLogger("Oslo.net.IframeIo"),t.prototype.form_=null,t.prototype.iframe_=null,t.prototype.iframeName_=null,t.prototype.nextIframeId_=0,t.prototype.active_=!1,t.prototype.complete_=!1,t.prototype.success_=!1,t.prototype.lastUri_=null,t.prototype.lastContent_=null,t.prototype.lastErrorCode_=j.NO_ERROR,t.prototype.timeoutInterval_=0,t.prototype.timeoutId_=null,t.prototype.firefoxSilentErrorTimeout_=null,t.prototype.iframeDisposalTimer_=null,t.prototype.errorHandled_=!1,t.prototype.ignoreResponse_=!1,t.prototype.send=function(a,b,c,d){if(this.active_)throw Error("[Oslo.net.IframeIo] Unable to send, already active.");var e=new p(a);this.lastUri_=e;var f=b?b.toUpperCase():"GET";c&&e.makeUnique(),n.info(this.logger_,"Sending iframe request: "+e+" ["+f+"]"),this.form_=t.getForm_(),"GET"==f&&t.addFormInputs_(this.form_,e.getQueryData()),d&&t.addFormInputs_(this.form_,d),this.form_.action=e.toString(),this.form_.method=f,this.sendFormInternal_()},t.prototype.sendFromForm=function(a,b,c){if(this.active_)throw Error("[Oslo.net.IframeIo] Unable to send, already active.");var d=new p(b||a.action);c&&d.makeUnique(),n.info(this.logger_,"Sending iframe request from form: "+d),this.lastUri_=d,this.form_=a,this.form_.action=d.toString(),this.sendFormInternal_()},t.prototype.abort=function(a){this.active_&&(n.info(this.logger_,"Request aborted"),e.removeAll(this.getRequestIframe()),this.complete_=!1,this.active_=!1,this.success_=!1,this.lastErrorCode_=a||j.ABORT,this.dispatchEvent(h.ABORT),this.makeReady_())},t.prototype.disposeInternal=function(){n.fine(this.logger_,"Disposing iframeIo instance"),this.active_&&(n.fine(this.logger_,"Aborting active request"),this.abort()),t.superClass_.disposeInternal.call(this),this.iframe_&&this.scheduleIframeDisposal_(),this.disposeForm_(),delete this.errorChecker_,this.form_=null,this.lastCustomError_=this.lastContent_=this.lastContentHtml_=null,this.lastUri_=null,this.lastErrorCode_=j.NO_ERROR,delete r[this.name_]},t.prototype.isComplete=function(){return this.complete_},t.prototype.isSuccess=function(){return this.success_},t.prototype.isActive=function(){return this.active_},t.prototype.getResponseText=function(){return this.lastContent_},t.prototype.getResponseHtml=function(){return this.lastContentHtml_},t.prototype.getResponseJson=function(){return json.parse(this.lastContent_)},t.prototype.getLastUri=function(){return this.lastUri_},t.prototype.getLastErrorCode=function(){return this.lastErrorCode_},t.prototype.getLastError=function(){return j.getDebugMessage(this.lastErrorCode_)},t.prototype.getLastCustomError=function(){return this.lastCustomError_},t.prototype.setErrorChecker=function(a){this.errorChecker_=a},t.prototype.getErrorChecker=function(){return this.errorChecker_},t.prototype.getTimeoutInterval=function(){return this.timeoutInterval_},t.prototype.setTimeoutInterval=function(a){this.timeoutInterval_=Math.max(0,a)},t.prototype.isIgnoringResponse=function(){return this.ignoreResponse_},t.prototype.setIgnoreResponse=function(a){this.ignoreResponse_=a},t.prototype.sendFormInternal_=function(){if(this.active_=!0,this.complete_=!1,this.lastErrorCode_=j.NO_ERROR,this.createIframe_(),m.isIE){this.form_.target=this.iframeName_||"",this.appendIframe_(),this.ignoreResponse_||e.listen(this.iframe_,h.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this);try{this.errorHandled_=!1,this.form_.submit()}catch(a){this.ignoreResponse_||e.unlisten(this.iframe_,h.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this),this.handleError_(j.ACCESS_DENIED)}}else{n.fine(this.logger_,"Setting up iframes and cloning form"),this.appendIframe_();var c=this.iframeName_+t.INNER_FRAME_SUFFIX,f=d.getFrameContentDocument(this.iframe_),g="<body><iframe id="+c+" name="+c+"></iframe>";document.baseURI&&(g='<head><base href="'+l.htmlEscape(document.baseURI)+'"></head>'+g),m.isOPERA?f.documentElement.innerHTML=g:f.write(g),this.ignoreResponse_||e.listen(f.getElementById(c),h.LOAD,this.onIframeLoaded_,!1,this);for(var i=this.form_.getElementsByTagName("textarea"),k=0,o=i.length;o>k;k++){var p=i[k].value;goog.dom.getRawTextContent(i[k])!=p&&(goog.dom.setTextContent(i[k],p),i[k].value=p)}var q=f.importNode(this.form_,!0);q.target=c,q.action=this.form_.action,f.body.appendChild(q);for(var r=this.form_.getElementsByTagName("select"),s=q.getElementsByTagName("select"),k=0,o=r.length;o>k;k++)for(var u=r[k].getElementsByTagName("option"),v=s[k].getElementsByTagName("option"),w=0,x=u.length;x>w;w++)v[w].selected=u[w].selected;for(var y=this.form_.getElementsByTagName("input"),z=q.getElementsByTagName("input"),k=0,o=y.length;o>k;k++)if("file"==y[k].type&&y[k].value!=z[k].value){n.fine(this.logger_,"File input value not cloned properly.  Will submit using original form."),this.form_.target=c,q=this.form_;break}n.fine(this.logger_,"Submitting form");try{this.errorHandled_=!1,q.submit(),f.close(),m.isGECKO&&(this.firefoxSilentErrorTimeout_=b.callOnce(this.testForFirefoxSilentError_,250,this))}catch(a){n.error(this.logger_,"Error when submitting form: "+goog.debug.exposeException(a)),this.ignoreResponse_||goog.events.unlisten(f.getElementById(c),h.LOAD,this.onIframeLoaded_,!1,this),f.close(),this.handleError_(j.FILE_NOT_FOUND)}}},t.prototype.onIeReadyStateChange_=function(){if("complete"==this.iframe_.readyState){goog.events.unlisten(this.iframe_,goog.events.EventType.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this);var a;try{if(a=goog.dom.getFrameContentDocument(this.iframe_),goog.userAgent.IE&&"about:blank"==a.location&&!navigator.onLine)return this.handleError_(goog.net.ErrorCode.OFFLINE),void 0}catch(b){return this.handleError_(goog.net.ErrorCode.ACCESS_DENIED),void 0}this.handleLoad_(a)}},t});